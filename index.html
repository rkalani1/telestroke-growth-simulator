<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telestroke Growth Projections</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background-color: #f9fafb;
            color: #111827;
            line-height: 1.5;
        }
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1rem 0;
            margin-bottom: 2rem;
        }
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header h1 {
            font-size: 1.875rem;
            font-weight: bold;
            color: #1f2937;
            margin: 0;
        }
        .header p {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background: #2563eb;
            color: white;
        }
        .btn-primary:hover {
            background: #1d4ed8;
        }
        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .btn-success {
            background: #16a34a;
            color: white;
        }
        .btn-success:hover {
            background: #15803d;
        }
        .btn-success:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
            box-sizing: border-box;
        }
        .card h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .card h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            font-weight: 600;
            color: #374151;
            background: #f9fafb;
        }
        .text-center {
            text-align: center;
        }
        .grid {
            display: grid;
            gap: 2rem;
            width: 100%;
        }
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 400px), 1fr));
        }
        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        .stat-box {
            background: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .stat-box.primary {
            background: #dbeafe;
        }
        .stat-box.danger {
            background: #fee2e2;
        }
        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }
        .stat-range {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .chart-container {
            position: relative;
            margin-top: 1rem;
            width: 100%;
            max-width: 100%;
            height: 280px;
            min-height: 250px;
            box-sizing: border-box;
        }
        .chart-container svg {
            width: 100%;
            height: 100%;
            display: block;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            color: #6b7280;
        }
        .spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .parameters-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }
        .parameter-section {
            background: #f3f4f6;
            padding: 1.5rem;
            border-radius: 0.5rem;
        }
        .parameter-section.primary {
            background: #e0f2fe;
        }
        .parameter-section.danger {
            background: #fee2e2;
        }
        .parameter-group {
            margin-bottom: 1rem;
        }
        .parameter-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        .parameter-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        .input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .input-group input {
            flex: 1;
        }
        .input-group span {
            color: #6b7280;
        }
        @media (max-width: 768px) {
            .grid-2, .grid-4, .parameters-grid {
                grid-template-columns: 1fr;
            }
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div>
                    <h1>Telestroke Growth Projections</h1>
                    <p>Monte Carlo Simulation Model</p>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                    <button id="exportBtn" class="btn btn-success" disabled>Export Data</button>
                    <button id="reportBtn" class="btn btn-primary" disabled>Generate Report</button>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Historical Data -->
        <div class="card">
            <h2>Historical Data</h2>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th class="text-center">Partner Sites</th>
                            <th class="text-center">Total Consults</th>
                            <th class="text-center">Video Consults</th>
                            <th class="text-center">Transfers</th>
                            <th class="text-center">Transfer Rate</th>
                        </tr>
                    </thead>
                    <tbody id="historicalTable">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Growth Parameters -->
        <div class="card">
            <h2>Growth Scenarios</h2>
            <div class="parameters-grid">
                <div class="parameter-section primary">
                    <h3>Continued Prior Growth</h3>
                    <div class="parameter-group">
                        <label>New Partner Sites per Year</label>
                        <input type="number" id="prior-partners" value="2" min="0" max="10">
                    </div>
                    <div class="parameter-group">
                        <label>Additional Consults per Year (Mean ± SD)</label>
                        <div class="input-group">
                            <input type="number" id="prior-consults-mean" value="100" min="0">
                            <input type="number" id="prior-consults-sd" value="25" min="0" style="width: 100px;">
                        </div>
                    </div>
                    <div class="parameter-group">
                        <label>Transfer Rate (% ± %)</label>
                        <div class="input-group">
                            <input type="number" id="prior-transfer-mean" value="20" min="0" max="100" style="width: 80px;">
                            <span>±</span>
                            <input type="number" id="prior-transfer-sd" value="5" min="0" max="50" style="width: 60px;">
                        </div>
                    </div>
                    <div class="parameter-group">
                        <label>Video Consult Growth per Year (Mean ± SD)</label>
                        <div class="input-group">
                            <input type="number" id="prior-video-mean" value="15" min="0">
                            <input type="number" id="prior-video-sd" value="5" min="0" style="width: 100px;">
                        </div>
                    </div>
                </div>

                <div class="parameter-section danger">
                    <h3>Conservative Growth</h3>
                    <div class="parameter-group">
                        <label>New Partner Sites per Year</label>
                        <input type="number" id="cons-partners" value="1" min="0" max="10">
                    </div>
                    <div class="parameter-group">
                        <label>Additional Consults per Year (Mean ± SD)</label>
                        <div class="input-group">
                            <input type="number" id="cons-consults-mean" value="50" min="0">
                            <input type="number" id="cons-consults-sd" value="15" min="0" style="width: 100px;">
                        </div>
                    </div>
                    <div class="parameter-group">
                        <label>Transfer Rate (% ± %)</label>
                        <div class="input-group">
                            <input type="number" id="cons-transfer-mean" value="15" min="0" max="100" style="width: 80px;">
                            <span>±</span>
                            <input type="number" id="cons-transfer-sd" value="5" min="0" max="50" style="width: 60px;">
                        </div>
                    </div>
                    <div class="parameter-group">
                        <label>Video Consult Growth per Year (Mean ± SD)</label>
                        <div class="input-group">
                            <input type="number" id="cons-video-mean" value="8" min="0">
                            <input type="number" id="cons-video-sd" value="3" min="0" style="width: 100px;">
                        </div>
                    </div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 1rem;">
                <button id="runSimBtn" class="btn btn-primary">Run Simulation (1000 iterations)</button>
            </div>
        </div>

        <!-- Charts -->
        <div id="chartsContainer" class="grid grid-2" style="display: none;">
            <div class="card">
                <h3>Annual Consults</h3>
                <div class="chart-container">
                    <svg id="chart-consults" viewBox="0 0 500 300" preserveAspectRatio="xMidYMid meet"></svg>
                </div>
            </div>
            <div class="card">
                <h3>Partner Sites</h3>
                <div class="chart-container">
                    <svg id="chart-partners" viewBox="0 0 500 300" preserveAspectRatio="xMidYMid meet"></svg>
                </div>
            </div>
            <div class="card">
                <h3>Patient Transfers</h3>
                <div class="chart-container">
                    <svg id="chart-transfers" viewBox="0 0 500 300" preserveAspectRatio="xMidYMid meet"></svg>
                </div>
            </div>
            <div class="card">
                <h3>Video Consults</h3>
                <div class="chart-container">
                    <svg id="chart-videoConsults" viewBox="0 0 500 300" preserveAspectRatio="xMidYMid meet"></svg>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div id="summaryContainer" class="card" style="display: none;">
            <h2>2030 Projections Summary</h2>
            <div class="grid grid-4" id="summaryGrid">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </main>

    <script>
        // Global state
        const state = {
            historicalData: {
                partners: { 2019: 5, 2020: 5, 2021: 7, 2022: 11, 2023: 12, 2024: 13 },
                consults: { 2019: 707, 2020: 639, 2021: 759, 2022: 912, 2023: 1031, 2024: 1171 },
                transfers: { 2019: 163, 2020: 167, 2021: 145, 2022: 175, 2023: 171, 2024: 252 },
                videoConsults: { 2019: 86, 2020: 99, 2021: 136, 2022: 154, 2023: 169, 2024: 182 }
            },
            simResults: null,
            projectionYears: [2025, 2026, 2027, 2028, 2029, 2030]
        };

        // Monte Carlo Simulation Functions
        function normalRandom(mean, sd) {
            let u = 0, v = 0;
            while(u === 0) u = Math.random();
            while(v === 0) v = Math.random();
            return mean + sd * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
        }

        function runSimulation() {
            const btn = document.getElementById('runSimBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span>Running Simulation...';

            // Get parameters
            const params = {
                prior: {
                    lambdaNewPartners: parseInt(document.getElementById('prior-partners').value),
                    meanConsultGrowth: parseInt(document.getElementById('prior-consults-mean').value),
                    sdConsultGrowth: parseInt(document.getElementById('prior-consults-sd').value),
                    meanTransferRate: parseInt(document.getElementById('prior-transfer-mean').value) / 100,
                    sdTransferRate: parseInt(document.getElementById('prior-transfer-sd').value) / 100,
                    meanVideoGrowth: parseInt(document.getElementById('prior-video-mean').value),
                    sdVideoGrowth: parseInt(document.getElementById('prior-video-sd').value)
                },
                conservative: {
                    lambdaNewPartners: parseInt(document.getElementById('cons-partners').value),
                    meanConsultGrowth: parseInt(document.getElementById('cons-consults-mean').value),
                    sdConsultGrowth: parseInt(document.getElementById('cons-consults-sd').value),
                    meanTransferRate: parseInt(document.getElementById('cons-transfer-mean').value) / 100,
                    sdTransferRate: parseInt(document.getElementById('cons-transfer-sd').value) / 100,
                    meanVideoGrowth: parseInt(document.getElementById('cons-video-mean').value),
                    sdVideoGrowth: parseInt(document.getElementById('cons-video-sd').value)
                }
            };

            setTimeout(() => {
                state.simResults = {
                    prior: simulate(params.prior),
                    conservative: simulate(params.conservative)
                };

                // Update UI
                updateCharts();
                updateSummary();
                document.getElementById('chartsContainer').style.display = 'grid';
                document.getElementById('summaryContainer').style.display = 'block';
                document.getElementById('exportBtn').disabled = false;
                document.getElementById('reportBtn').disabled = false;

                btn.disabled = false;
                btn.innerHTML = 'Run Simulation (1000 iterations)';
            }, 100);
        }

        function simulate(params) {
            const numSimulations = 1000;
            const results = {
                partners: [],
                consults: [],
                transfers: [],
                videoConsults: []
            };

            const years = Object.keys(state.historicalData.partners).sort();
            const lastYear = years[years.length - 1];
            const currentPartners = state.historicalData.partners[lastYear];
            const currentConsults = state.historicalData.consults[lastYear];
            const currentVideoConsults = state.historicalData.videoConsults[lastYear];

            // Run simulations
            for (let sim = 0; sim < numSimulations; sim++) {
                let partners = currentPartners;
                let consults = currentConsults;
                let videoConsults = currentVideoConsults;
                
                const simData = {
                    partners: [],
                    consults: [],
                    transfers: [],
                    videoConsults: []
                };

                for (let yearIdx = 0; yearIdx < state.projectionYears.length; yearIdx++) {
                    const newPartners = yearIdx === 0 ? 3 : params.lambdaNewPartners;
                    partners += newPartners;

                    const meanPerPartner = params.meanConsultGrowth / Math.max(1, params.lambdaNewPartners);
                    const sdPerPartner = params.sdConsultGrowth / Math.sqrt(Math.max(1, params.lambdaNewPartners));
                    let growth = 0;
                    for (let i = 0; i < newPartners; i++) {
                        growth += normalRandom(meanPerPartner, sdPerPartner);
                    }
                    consults += growth;

                    videoConsults += normalRandom(params.meanVideoGrowth, params.sdVideoGrowth);

                    let transferRate = normalRandom(params.meanTransferRate, params.sdTransferRate);
                    transferRate = Math.max(0, Math.min(1, transferRate));
                    const transfers = Math.round(consults * transferRate);

                    simData.partners.push(partners);
                    simData.consults.push(consults);
                    simData.transfers.push(transfers);
                    simData.videoConsults.push(Math.max(0, Math.round(videoConsults)));
                }

                results.partners.push(simData.partners);
                results.consults.push(simData.consults);
                results.transfers.push(simData.transfers);
                results.videoConsults.push(simData.videoConsults);
            }

            // Calculate summary statistics
            const summary = {
                partners: [],
                consults: [],
                transfers: [],
                videoConsults: []
            };

            for (let yearIdx = 0; yearIdx < state.projectionYears.length; yearIdx++) {
                ['partners', 'consults', 'transfers', 'videoConsults'].forEach(metric => {
                    const values = results[metric].map(sim => sim[yearIdx]).sort((a, b) => a - b);
                    summary[metric].push({
                        year: state.projectionYears[yearIdx],
                        mean: values.reduce((a, b) => a + b, 0) / values.length,
                        ciLower: values[Math.floor(values.length * 0.025)],
                        ciUpper: values[Math.floor(values.length * 0.975)]
                    });
                });
            }

            return summary;
        }

        // UI Update Functions
        function populateHistoricalTable() {
            const tbody = document.getElementById('historicalTable');
            const years = Object.keys(state.historicalData.partners).sort();
            
            tbody.innerHTML = years.map(year => `
                <tr>
                    <td>${year}</td>
                    <td class="text-center">${state.historicalData.partners[year]}</td>
                    <td class="text-center">${state.historicalData.consults[year].toLocaleString()}</td>
                    <td class="text-center">${state.historicalData.videoConsults[year]}</td>
                    <td class="text-center">${state.historicalData.transfers[year]}</td>
                    <td class="text-center">${((state.historicalData.transfers[year] / state.historicalData.consults[year]) * 100).toFixed(1)}%</td>
                </tr>
            `).join('');
        }

        function updateCharts() {
            ['consults', 'partners', 'transfers', 'videoConsults'].forEach(metric => {
                drawChart(metric);
            });
        }

        function drawChart(metric) {
            const svg = document.getElementById(`chart-${metric}`);
            svg.setAttribute('viewBox', '0 0 500 300');
            svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');
            
            const width = 500;
            const height = 300;
            const margin = { top: 20, right: 50, bottom: 50, left: 80 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            // Prepare data
            const data = [];
            Object.keys(state.historicalData[metric]).sort().forEach(year => {
                data.push({
                    year: parseInt(year),
                    historical: state.historicalData[metric][year]
                });
            });
            
            state.simResults.prior[metric].forEach((point, idx) => {
                const conservativePoint = state.simResults.conservative[metric][idx];
                data.push({
                    year: point.year,
                    priorMean: point.mean,
                    conservativeMean: conservativePoint.mean
                });
            });

            // Calculate scales
            const allValues = [];
            data.forEach(d => {
                if (d.historical !== undefined) allValues.push(d.historical);
                if (d.priorMean !== undefined) allValues.push(d.priorMean);
                if (d.conservativeMean !== undefined) allValues.push(d.conservativeMean);
            });
            
            const yMin = Math.min(...allValues) * 0.9;
            const yMax = Math.max(...allValues) * 1.1;
            const xMin = Math.min(...data.map(d => d.year));
            const xMax = Math.max(...data.map(d => d.year));

            const xScale = (year) => margin.left + ((year - xMin) / (xMax - xMin)) * innerWidth;
            const yScale = (value) => margin.top + innerHeight - ((value - yMin) / (yMax - yMin)) * innerHeight;

            // Clear existing content
            svg.innerHTML = '';

            // Add grid lines
            for (let i = 0; i <= 5; i++) {
                const y = margin.top + (innerHeight * i / 5);
                const value = yMax - (yMax - yMin) * i / 5;
                
                svg.innerHTML += `
                    <line x1="${margin.left}" y1="${y}" x2="${margin.left + innerWidth}" y2="${y}" 
                          stroke="#e5e7eb" stroke-width="1"/>
                    <text x="${margin.left - 15}" y="${y + 5}" text-anchor="end" font-size="12" fill="#6b7280">
                        ${Math.round(value)}
                    </text>
                `;
            }

            // Add x-axis labels
            data.filter((d, i) => i % 2 === 0).forEach(d => {
                svg.innerHTML += `
                    <text x="${xScale(d.year)}" y="${margin.top + innerHeight + 30}" 
                          text-anchor="middle" font-size="12" fill="#6b7280">${d.year}</text>
                `;
            });

            // Draw lines
            const historicalPath = data
                .filter(d => d.historical !== undefined)
                .map((d, i) => `${i === 0 ? 'M' : 'L'} ${xScale(d.year)} ${yScale(d.historical)}`)
                .join(' ');

            const priorPath = data
                .filter(d => d.priorMean !== undefined)
                .map((d, i) => `${i === 0 ? 'M' : 'L'} ${xScale(d.year)} ${yScale(d.priorMean)}`)
                .join(' ');

            const conservativePath = data
                .filter(d => d.conservativeMean !== undefined)
                .map((d, i) => `${i === 0 ? 'M' : 'L'} ${xScale(d.year)} ${yScale(d.conservativeMean)}`)
                .join(' ');

            svg.innerHTML += `
                <path d="${historicalPath}" stroke="#1f2937" stroke-width="3" fill="none"/>
                <path d="${priorPath}" stroke="#0891b2" stroke-width="2" stroke-dasharray="5,5" fill="none"/>
                <path d="${conservativePath}" stroke="#dc2626" stroke-width="2" stroke-dasharray="5,5" fill="none"/>
                
                <!-- 2024 reference line -->
                <line x1="${xScale(2024)}" y1="${margin.top}" x2="${xScale(2024)}" y2="${margin.top + innerHeight}" 
                      stroke="#9ca3af" stroke-width="1" stroke-dasharray="3,3"/>
                
                <!-- Legend -->
                <g transform="translate(${margin.left + innerWidth - 130}, ${margin.top})">
                    <rect x="-5" y="-5" width="120" height="60" fill="white" stroke="#e5e7eb" stroke-width="1" rx="3"/>
                    <line x1="0" y1="0" x2="20" y2="0" stroke="#1f2937" stroke-width="3"/>
                    <text x="25" y="4" font-size="11" fill="#374151">Historical</text>
                    
                    <line x1="0" y1="20" x2="20" y2="20" stroke="#0891b2" stroke-width="2" stroke-dasharray="5,5"/>
                    <text x="25" y="24" font-size="11" fill="#374151">Prior Growth</text>
                    
                    <line x1="0" y1="40" x2="20" y2="40" stroke="#dc2626" stroke-width="2" stroke-dasharray="5,5"/>
                    <text x="25" y="44" font-size="11" fill="#374151">Conservative</text>
                </g>
            `;
        }

        function updateSummary() {
            const grid = document.getElementById('summaryGrid');
            const metrics = [
                { key: 'consults', label: 'Annual Consults' },
                { key: 'partners', label: 'Partner Sites' },
                { key: 'transfers', label: 'Patient Transfers' },
                { key: 'videoConsults', label: 'Video Consults' }
            ];

            grid.innerHTML = metrics.map(({ key, label }) => {
                const prior = state.simResults.prior[key][5];
                const cons = state.simResults.conservative[key][5];
                
                return `
                    <div>
                        <h3>${label}</h3>
                        <div class="stat-box primary">
                            <div class="stat-label">Continued Prior Growth</div>
                            <div class="stat-value">${Math.round(prior.mean).toLocaleString()}</div>
                            <div class="stat-range">
                                95% CI: ${Math.round(prior.ciLower).toLocaleString()} - ${Math.round(prior.ciUpper).toLocaleString()}
                            </div>
                        </div>
                        <div class="stat-box danger">
                            <div class="stat-label">Conservative</div>
                            <div class="stat-value">${Math.round(cons.mean).toLocaleString()}</div>
                            <div class="stat-range">
                                95% CI: ${Math.round(cons.ciLower).toLocaleString()} - ${Math.round(cons.ciUpper).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function exportCSV() {
            if (!state.simResults) return;

            let csvContent = "Year,Metric,Scenario,Mean,CI_Lower,CI_Upper\n";
            
            ['partners', 'consults', 'transfers', 'videoConsults'].forEach(metric => {
                Object.keys(state.historicalData[metric]).forEach(year => {
                    csvContent += `${year},${metric},historical,${state.historicalData[metric][year]},,\n`;
                });
                
                ['prior', 'conservative'].forEach(scenario => {
                    state.simResults[scenario][metric].forEach(point => {
                        csvContent += `${point.year},${metric},${scenario},${point.mean.toFixed(0)},${point.ciLower.toFixed(0)},${point.ciUpper.toFixed(0)}\n`;
                    });
                });
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'telestroke_projections.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function generateReport() {
            if (!state.simResults) return;
            
            let report = `TELESTROKE PROGRAM GROWTH PROJECTIONS\n`;
            report += `${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}\n`;
            report += `${'='.repeat(80)}\n\n`;
            
            const lastIdx = state.simResults.prior.consults.length - 1;
            const currentConsults = state.historicalData.consults[2024];
            const projectedPrior = state.simResults.prior.consults[lastIdx].mean;
            const projectedCons = state.simResults.conservative.consults[lastIdx].mean;
            
            report += `Current Annual Consults (2024): ${currentConsults.toLocaleString()}\n\n`;
            report += `Projected 2030 Consults:\n`;
            report += `• Continued Prior Growth: ${Math.round(projectedPrior).toLocaleString()} (${((projectedPrior/currentConsults - 1) * 100).toFixed(1)}% growth)\n`;
            report += `  95% CI: ${Math.round(state.simResults.prior.consults[lastIdx].ciLower).toLocaleString()} - ${Math.round(state.simResults.prior.consults[lastIdx].ciUpper).toLocaleString()}\n\n`;
            report += `• Conservative: ${Math.round(projectedCons).toLocaleString()} (${((projectedCons/currentConsults - 1) * 100).toFixed(1)}% growth)\n`;
            report += `  95% CI: ${Math.round(state.simResults.conservative.consults[lastIdx].ciLower).toLocaleString()} - ${Math.round(state.simResults.conservative.consults[lastIdx].ciUpper).toLocaleString()}\n`;
            
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Telestroke_Report_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            populateHistoricalTable();
            
            // Event listeners
            document.getElementById('runSimBtn').addEventListener('click', runSimulation);
            document.getElementById('exportBtn').addEventListener('click', exportCSV);
            document.getElementById('reportBtn').addEventListener('click', generateReport);
            
            // Run initial simulation
            runSimulation();
        });
    </script>
</body>
</html>
