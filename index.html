<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telestroke Growth Projections</title>
    
    <!-- React and ReactDOM - Using older stable versions -->
    <script crossorigin src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone@7.12.4/babel.min.js"></script>
    
    <!-- Recharts and dependencies -->
    <script src="https://unpkg.com/prop-types@15.6.0/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.1.9/dist/Recharts.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Fallback styles in case Tailwind doesn't load */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f9fafb;
        }
        #root {
            min-height: 100vh;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 24px;
            color: #3b82f6;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading">Loading Telestroke Simulator...</div>
    </div>

    <script type="text/babel">
        console.log("Script starting...");
        
        // Check if dependencies loaded
        if (typeof React === 'undefined') {
            console.error('React not loaded');
            document.getElementById('root').innerHTML = '<div style="color: red; padding: 20px;">Error: React not loaded. Please refresh the page.</div>';
        }
        if (typeof Recharts === 'undefined') {
            console.error('Recharts not loaded');
        }
        
        const { useState, useEffect, useCallback, useMemo } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Area, ComposedChart, ReferenceLine } = window.Recharts || {};

        console.log("Dependencies loaded, creating app...");

        // Monte Carlo Simulation Engine
        class TelestrokeSimulator {
            constructor() {
                this.numSimulations = 1000;
                this.projectionYears = [2025, 2026, 2027, 2028, 2029, 2030];
            }

            normalRandom(mean, sd) {
                let u = 0, v = 0;
                while(u === 0) u = Math.random();
                while(v === 0) v = Math.random();
                return mean + sd * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
            }

            simulate(historicalData, growthParams) {
                const { lambdaNewPartners, meanConsultGrowth, sdConsultGrowth, meanTransferRate, sdTransferRate, meanVideoGrowth, sdVideoGrowth } = growthParams;
                
                const simResults = {
                    partners: [],
                    consults: [],
                    transfers: [],
                    videoConsults: []
                };

                const years = Object.keys(historicalData.partners).sort();
                const lastYear = years[years.length - 1];
                const currentPartners = historicalData.partners[lastYear];
                const currentConsults = historicalData.consults[lastYear];
                const currentVideoConsults = historicalData.videoConsults[lastYear];

                for (let sim = 0; sim < this.numSimulations; sim++) {
                    let partners = currentPartners;
                    let consults = currentConsults;
                    let videoConsults = currentVideoConsults;
                    
                    const partnersSim = [];
                    const consultsSim = [];
                    const transfersSim = [];
                    const videoConsultsSim = [];

                    for (let yearIdx = 0; yearIdx < this.projectionYears.length; yearIdx++) {
                        const newPartners = yearIdx === 0 ? 3 : lambdaNewPartners;
                        partners += newPartners;

                        const meanPerPartner = meanConsultGrowth / Math.max(1, lambdaNewPartners);
                        const sdPerPartner = sdConsultGrowth / Math.sqrt(Math.max(1, lambdaNewPartners));
                        let growth = 0;
                        for (let i = 0; i < newPartners; i++) {
                            growth += this.normalRandom(meanPerPartner, sdPerPartner);
                        }
                        consults += growth;

                        videoConsults += this.normalRandom(meanVideoGrowth, sdVideoGrowth);

                        let transferRate = this.normalRandom(meanTransferRate, sdTransferRate);
                        transferRate = Math.max(0, Math.min(1, transferRate));
                        const transfers = Math.round(consults * transferRate);

                        partnersSim.push(partners);
                        consultsSim.push(consults);
                        transfersSim.push(transfers);
                        videoConsultsSim.push(Math.max(0, Math.round(videoConsults)));
                    }

                    simResults.partners.push(partnersSim);
                    simResults.consults.push(consultsSim);
                    simResults.transfers.push(transfersSim);
                    simResults.videoConsults.push(videoConsultsSim);
                }

                return this.calculateSummaryStats(simResults);
            }

            calculateSummaryStats(simResults) {
                const summary = {
                    partners: [],
                    consults: [],
                    transfers: [],
                    videoConsults: []
                };

                for (let yearIdx = 0; yearIdx < this.projectionYears.length; yearIdx++) {
                    const partnersYear = simResults.partners.map(sim => sim[yearIdx]).sort((a, b) => a - b);
                    const consultsYear = simResults.consults.map(sim => sim[yearIdx]).sort((a, b) => a - b);
                    const transfersYear = simResults.transfers.map(sim => sim[yearIdx]).sort((a, b) => a - b);
                    const videoConsultsYear = simResults.videoConsults.map(sim => sim[yearIdx]).sort((a, b) => a - b);

                    summary.partners.push({
                        year: this.projectionYears[yearIdx],
                        mean: partnersYear.reduce((a, b) => a + b, 0) / partnersYear.length,
                        ciLower: partnersYear[Math.floor(partnersYear.length * 0.025)],
                        ciUpper: partnersYear[Math.floor(partnersYear.length * 0.975)]
                    });

                    summary.consults.push({
                        year: this.projectionYears[yearIdx],
                        mean: consultsYear.reduce((a, b) => a + b, 0) / consultsYear.length,
                        ciLower: consultsYear[Math.floor(consultsYear.length * 0.025)],
                        ciUpper: consultsYear[Math.floor(consultsYear.length * 0.975)]
                    });

                    summary.transfers.push({
                        year: this.projectionYears[yearIdx],
                        mean: transfersYear.reduce((a, b) => a + b, 0) / transfersYear.length,
                        ciLower: transfersYear[Math.floor(transfersYear.length * 0.025)],
                        ciUpper: transfersYear[Math.floor(transfersYear.length * 0.975)]
                    });

                    summary.videoConsults.push({
                        year: this.projectionYears[yearIdx],
                        mean: videoConsultsYear.reduce((a, b) => a + b, 0) / videoConsultsYear.length,
                        ciLower: videoConsultsYear[Math.floor(videoConsultsYear.length * 0.025)],
                        ciUpper: videoConsultsYear[Math.floor(videoConsultsYear.length * 0.975)]
                    });
                }

                return summary;
            }
        }

        // Main App Component
        function TelestrokeSimulatorApp() {
            console.log("App component rendering...");
            
            const [mounted, setMounted] = useState(false);
            const [historicalData, setHistoricalData] = useState({
                partners: { 2019: 5, 2020: 5, 2021: 7, 2022: 11, 2023: 12, 2024: 13 },
                consults: { 2019: 707, 2020: 639, 2021: 759, 2022: 912, 2023: 1031, 2024: 1171 },
                transfers: { 2019: 163, 2020: 167, 2021: 145, 2022: 175, 2023: 171, 2024: 252 },
                videoConsults: { 2019: 86, 2020: 99, 2021: 136, 2022: 154, 2023: 169, 2024: 182 }
            });

            const [growthScenarios, setGrowthScenarios] = useState({
                prior: {
                    lambdaNewPartners: 2,
                    meanConsultGrowth: 100,
                    sdConsultGrowth: 25,
                    meanTransferRate: 0.2,
                    sdTransferRate: 0.05,
                    meanVideoGrowth: 15,
                    sdVideoGrowth: 5
                },
                conservative: {
                    lambdaNewPartners: 1,
                    meanConsultGrowth: 50,
                    sdConsultGrowth: 15,
                    meanTransferRate: 0.15,
                    sdTransferRate: 0.05,
                    meanVideoGrowth: 8,
                    sdVideoGrowth: 3
                }
            });

            const [showConfidenceInterval, setShowConfidenceInterval] = useState(true);
            const [simResults, setSimResults] = useState(null);
            const [isSimulating, setIsSimulating] = useState(false);
            const [expandedSections, setExpandedSections] = useState({
                historical: true,
                parameters: true
            });
            const [editingHistorical, setEditingHistorical] = useState(false);

            const simulator = useMemo(() => new TelestrokeSimulator(), []);

            const runSimulation = useCallback(() => {
                console.log("Running simulation...");
                setIsSimulating(true);
                
                setTimeout(() => {
                    try {
                        const priorResults = simulator.simulate(historicalData, growthScenarios.prior);
                        const conservativeResults = simulator.simulate(historicalData, growthScenarios.conservative);
                        
                        setSimResults({
                            prior: priorResults,
                            conservative: conservativeResults
                        });
                        console.log("Simulation complete", { priorResults, conservativeResults });
                    } catch (error) {
                        console.error("Simulation error:", error);
                    }
                    setIsSimulating(false);
                }, 100);
            }, [historicalData, growthScenarios, simulator]);

            useEffect(() => {
                setMounted(true);
                runSimulation();
            }, []);

            const prepareChartData = (metric) => {
                if (!simResults) return [];

                const historicalYears = Object.keys(historicalData[metric]).sort();
                const data = [];

                historicalYears.forEach(year => {
                    data.push({
                        year: parseInt(year),
                        historical: historicalData[metric][year],
                        type: 'historical'
                    });
                });

                simResults.prior[metric].forEach((point, idx) => {
                    const conservativePoint = simResults.conservative[metric][idx];
                    data.push({
                        year: point.year,
                        priorMean: point.mean,
                        priorCiLower: point.ciLower,
                        priorCiUpper: point.ciUpper,
                        priorCiDiff: point.ciUpper - point.ciLower,
                        conservativeMean: conservativePoint.mean,
                        conservativeCiLower: conservativePoint.ciLower,
                        conservativeCiUpper: conservativePoint.ciUpper,
                        conservativeCiDiff: conservativePoint.ciUpper - conservativePoint.ciLower,
                        type: 'projection'
                    });
                });

                return data;
            };

            const exportCSV = () => {
                if (!simResults) return;

                let csvContent = "Year,Metric,Scenario,Mean,CI_Lower,CI_Upper\n";
                
                ['partners', 'consults', 'transfers', 'videoConsults'].forEach(metric => {
                    Object.keys(historicalData[metric]).forEach(year => {
                        csvContent += `${year},${metric},historical,${historicalData[metric][year]},,\n`;
                    });
                    
                    ['prior', 'conservative'].forEach(scenario => {
                        simResults[scenario][metric].forEach(point => {
                            csvContent += `${point.year},${metric},${scenario},${point.mean.toFixed(0)},${point.ciLower.toFixed(0)},${point.ciUpper.toFixed(0)}\n`;
                        });
                    });
                });

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'telestroke_projections.csv';
                a.click();
            };

            if (!mounted) {
                return <div className="p-8">Loading...</div>;
            }

            // Simplified UI without complex icons
            return (
                <div className="min-h-screen bg-gray-50">
                    <header className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-4 py-4">
                            <h1 className="text-2xl font-bold text-gray-900">Telestroke Growth Projections</h1>
                            <p className="text-sm text-gray-600">Monte Carlo Simulation Model</p>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        {/* Basic info section */}
                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h2 className="text-lg font-semibold mb-4">Simulation Controls</h2>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <p className="text-sm text-gray-600 mb-2">Show Confidence Intervals</p>
                                    <input
                                        type="checkbox"
                                        checked={showConfidenceInterval}
                                        onChange={(e) => setShowConfidenceInterval(e.target.checked)}
                                        className="mr-2"
                                    />
                                    <span className="text-sm">95% CI</span>
                                </div>
                                <div className="text-right">
                                    <button
                                        onClick={runSimulation}
                                        disabled={isSimulating}
                                        className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:opacity-50"
                                    >
                                        {isSimulating ? 'Running...' : 'Run Simulation'}
                                    </button>
                                    <button
                                        onClick={exportCSV}
                                        className="ml-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                                        disabled={!simResults}
                                    >
                                        Export CSV
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Historical Data Table */}
                        <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                            <h2 className="text-lg font-semibold mb-4">Historical Data</h2>
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead>
                                        <tr className="border-b">
                                            <th className="text-left py-2">Year</th>
                                            <th className="text-center py-2">Partners</th>
                                            <th className="text-center py-2">Consults</th>
                                            <th className="text-center py-2">Video</th>
                                            <th className="text-center py-2">Transfers</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {Object.keys(historicalData.partners).sort().map(year => (
                                            <tr key={year} className="border-b">
                                                <td className="py-2">{year}</td>
                                                <td className="text-center">{historicalData.partners[year]}</td>
                                                <td className="text-center">{historicalData.consults[year]}</td>
                                                <td className="text-center">{historicalData.videoConsults[year]}</td>
                                                <td className="text-center">{historicalData.transfers[year]}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Charts */}
                        {simResults && window.Recharts && (
                            <div className="bg-white rounded-lg shadow-md p-6 mb-6">
                                <h2 className="text-lg font-semibold mb-4">Annual Consults Projection</h2>
                                <div style={{ width: '100%', height: 400 }}>
                                    <ResponsiveContainer>
                                        <LineChart data={prepareChartData('consults')}>
                                            <CartesianGrid strokeDasharray="3 3" />
                                            <XAxis dataKey="year" />
                                            <YAxis />
                                            <Tooltip />
                                            <Line type="monotone" dataKey="historical" stroke="#000" strokeWidth={3} />
                                            <Line type="monotone" dataKey="priorMean" stroke="#0891b2" strokeWidth={2} strokeDasharray="5 5" />
                                            <Line type="monotone" dataKey="conservativeMean" stroke="#dc2626" strokeWidth={2} strokeDasharray="5 5" />
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        )}

                        {/* Summary Statistics */}
                        {simResults && (
                            <div className="bg-white rounded-lg shadow-md p-6">
                                <h2 className="text-lg font-semibold mb-4">2030 Projections Summary</h2>
                                <div className="grid grid-cols-2 gap-6">
                                    <div>
                                        <h3 className="font-medium text-gray-700 mb-2">Continued Prior Growth</h3>
                                        <div className="bg-blue-50 p-4 rounded">
                                            <p className="text-2xl font-bold text-blue-900">
                                                {Math.round(simResults.prior.consults[simResults.prior.consults.length - 1].mean).toLocaleString()} consults
                                            </p>
                                            <p className="text-sm text-blue-700">
                                                95% CI: {Math.round(simResults.prior.consults[simResults.prior.consults.length - 1].ciLower).toLocaleString()} - {Math.round(simResults.prior.consults[simResults.prior.consults.length - 1].ciUpper).toLocaleString()}
                                            </p>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 className="font-medium text-gray-700 mb-2">Conservative Growth</h3>
                                        <div className="bg-red-50 p-4 rounded">
                                            <p className="text-2xl font-bold text-red-900">
                                                {Math.round(simResults.conservative.consults[simResults.conservative.consults.length - 1].mean).toLocaleString()} consults
                                            </p>
                                            <p className="text-sm text-red-700">
                                                95% CI: {Math.round(simResults.conservative.consults[simResults.conservative.consults.length - 1].ciLower).toLocaleString()} - {Math.round(simResults.conservative.consults[simResults.conservative.consults.length - 1].ciUpper).toLocaleString()}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        // Render the app
        console.log("Attempting to render app...");
        try {
            ReactDOM.render(<TelestrokeSimulatorApp />, document.getElementById('root'));
            console.log("App rendered successfully");
        } catch (error) {
            console.error("Error rendering app:", error);
            document.getElementById('root').innerHTML = '<div style="color: red; padding: 20px;">Error loading application: ' + error.message + '</div>';
        }
    </script>
</body>
</html>
